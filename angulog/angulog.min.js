var app=angular.module("AnguLog",[],["$interpolateProvider",function(e){}]);app.controller("loginController",["$scope","$http","$rootScope",function(e,t,r){e.active=!config.logged_in;e.error="";e.showerror=false;var o=false;e.login=function(){if(e.trying)return;e.trying=true;t.post("?api=login",{name:e.name,pw:e.pw}).success(function(t,o,n,i){e.trying=false;if(t.success){e.deactivate();r.$emit("logged_in")}else{e.showerror=true;e.error=t.error}}).error(function(t,r,o,n){alert("Server Error ("+r+")!\nPlease retry.");e.trying=false})};r.$on("logged_out",function(t,r){e.activate()});e.deactivate=function(){e.pw="";e.showerror=false;e.active=false};e.activate=function(){e.active=true}}]);app.controller("logController",["$scope","$http","$rootScope","$window","API","$timeout",function(e,t,r,o,n,i){e.refreshing=false;e.stopRefresh=function(){e.refreshing=false;r.$emit("refresh_off")};e.startRefresh=function(){if(e.refreshing)return;e.refreshing=true;r.$emit("refresh_on");if(!refreshRunning)e.refresh()};e.toggleRefresh=function(){if(e.refreshing)e.stopRefresh();else e.startRefresh()};e.lmdiv="Loading more ...";refreshRunning=false;e.newestRequest="";e.oldestRequest="";e.data=[];e.refresh=function(){if(!e.refreshing)return;if(e.newestRequest===""){n.request({api:"get"},function(t){e.data=t;e.newestRequest=t[0].id;e.refresh();e.oldestRequest=t[t.length-1].id})}else{n.request({api:"get",after:e.newestRequest},function(t){if(t.length>0){e.data=t.concat(e.data);e.newestRequest=t[0].id}i(e.refresh,config.refresh_time)})}};var f=null,s=null,a=0;e.timeFormat=function(e){if(++a%25==0){f=moment().startOf("day");s=moment().subtract(1,"days")}var t=moment.unix(e);if(config.substituteNearDates){var r=t.clone().startOf("day");if(r.isSame(f))return t.format("[Today], H:mm:ss");if(r.isSame(s))return t.format("[Yesterday], H:mm:ss")}return t.format(config.dateFormat)};e.levelToCSS=function(e){if(e<200)return"error-debug";if(e<300)return"error-notify";if(e<400)return"error-warning";if(e<500)return"error-error";return"error-emergency"};r.$on("logged_in",function(){e.activate()});r.$on("logged_out",function(){e.deactivate()});r.$on("toggle_refresh",function(){e.toggleRefresh()});e.deactivate=function(){e.active=false;e.data=[];l=false;e.newestRequest="";e.oldestRequest=""};e.activate=function(){e.data=[];e.active=true;e.startRefresh()};isActive=function(){return e.active};o.onscroll=function(t){if(e.active&&!u&&e.oldestRequest!=""&&(document.documentElement&&document.documentElement.scrollTop||document.body.scrollTop)+window.innerHeight+50>=(document.documentElement&&document.documentElement.scrollHeight||document.body.scrollHeight)){loadMore()}};var u=false;var l=false;loadMore=function(){if(u||l)return;u=true;n.request({api:"get",bottom:e.oldestRequest},function(t){u=false;if(t.length>0){e.data=e.data.concat(t);e.oldestRequest=t[t.length-1].id}else{l=true;e.lmdiv="No more entries!"}})};if(config.logged_in)e.activate()}]);app.controller("logCtrlController",["$scope","$rootScope","$http","API",function(e,t,r,o){e.active=config.logged_in;e.refreshing=config.logged_in;e.toggleRefresh=function(){t.$emit("toggle_refresh")};t.$on("refresh_on",function(){e.refreshing=true});t.$on("refresh_off",function(){e.refreshing=false});e.logout=function(){o.request({api:"logout"},function(r){t.$emit("logged_out");e.active=false})};t.$on("logged_in",function(){e.active=true})}]);app.controller("configController",["$rootScope",function(e){e.$on("logged_in",function(){config.logged_in=true});e.$on("logged_out",function(){config.logged_in=false})}]);app.factory("API",["$http",function e(t){var r={handleError:function(e,t){if(!config.logged_in)return;alert("Error ("+t+"): "+e.error);if(e.reload)$window.location.reload()},request:function(e,o){t({url:"?",method:"GET",params:e}).success(function(e,t,n,i){if(e.success){o(e.data)}else r.handleError(e,t)}).error(function(e,t,r,o){alert("Web request failed!\nPlease retry.")})}};return r}]);